name: Assign Copilot on new issues

on:
  issues:
    types: [opened]

permissions:
  issues: write
  contents: read

jobs:
  assign-copilot:
    runs-on: ubuntu-latest
    steps:
      - name: Assign Copilot via GraphQL
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.COPILOT_ASSIGN_PAT }}
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;

            // 1) Discover the Copilot actor for this repository
            const repoInfo = await github.graphql(`
              query($owner: String!, $repo: String!) {
                repository(owner: $owner, name: $repo) {
                  id
                  suggestedActors(capabilities: [CAN_BE_ASSIGNED], first: 100) {
                    nodes { login __typename ... on Bot { id } ... on User { id } }
                  }
                }
              }
            `, { owner, repo });

            const actors = repoInfo.repository?.suggestedActors?.nodes ?? [];
            // Copilot may appear as 'copilot' or 'copilot-swe-agent' depending on rollout
            const copilotActor =
              actors.find(a => a.login === 'copilot' && a.__typename === 'Bot') ||
              actors.find(a => a.login === 'copilot-swe-agent' && a.__typename === 'Bot') ||
              actors.find(a => a.__typename === 'Bot' && a.login.toLowerCase().includes('copilot'));

            if (!copilotActor) {
              core.setFailed('Copilot actor not found. Ensure Copilot coding agent is enabled and visible as an Assignee in this repo.');
              return;
            }

            // 2) Assign the newly opened issue to Copilot
            const issueId = context.payload.issue.node_id; // GraphQL ID for the opened issue
            await github.graphql(`
              mutation($assignable: ID!, $assignees: [ID!]!) {
                addAssigneesToAssignable(input: { assignableId: $assignable, assigneeIds: $assignees }) {
                  assignable { ... on Issue { number assignees(first:10){ nodes { login } } } }
                }
              }
            `, { assignable: issueId, assignees: [copilotActor.id] });

            core.info(`Assigned issue #${context.payload.issue.number} to ${copilotActor.login}`);
